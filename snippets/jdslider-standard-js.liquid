{% javascript %}
(function () {

  /**
   * Initialize slider inside ONE section
   */
  function initSlider(section) {
    const slider = section.querySelector('.jdslider[data-tier="standard"]');
    if (!slider) return;

    // Prevent double init
    if (slider.swiper) return;

    // AUTOPLAY SETTINGS
    const AUTOPLAY = slider.dataset.autoplay === 'true';
    const AUTOPLAY_DELAY = parseInt(slider.dataset.autoplayDelay) || 3000;
    const PAUSE_ON_HOVER = slider.dataset.pauseOnHover === 'true';

    // PAGINATION SETTING
    const PAGINATION_EL = slider.querySelector('.jdslider__pagination');
    const PAGINATION_RADIUS = 10; // DO NOT EDIT
    const PAGINATION_CIRCUMFERENCE = -(2 * Math.PI * PAGINATION_RADIUS);  //-62.83  Formula: C=2Ï€r 
    
    // SETTINGS
    const SPEED = parseInt(slider.dataset.speed) || 300;
    const EFFECT = slider.dataset.effect || 'slide';


    function animateActiveSlide(swiper) {
      const activeSlide = swiper.slides[swiper.activeIndex];
      if (!activeSlide) return;

      activeSlide.querySelectorAll('.jdslider__content-item').forEach((el, index) => {
        el.style.transitionDelay = `${index * 0.15}s`;
        el.classList.add('show');
      });
    }

    function resetSlideItems(swiper) {
      swiper.slides.forEach(slide => {
        slide.querySelectorAll('.jdslider__content-item').forEach(el => {
          el.classList.remove('show');
          el.style.transitionDelay = '0s';
        });
      });
    }

    const swiper = new Swiper(slider, {
      effect: EFFECT,
      loop: true,
      speed: SPEED,
      autoplay: AUTOPLAY
      ? { 
          delay: AUTOPLAY_DELAY,
          pauseOnMouseEnter: PAUSE_ON_HOVER
        } 
      : false,

      navigation: {
        addIcons: false,
        nextEl: slider.querySelector('.jdslider__nav-button-next'),
        prevEl: slider.querySelector('.jdslider__nav-button-prev'),
      },

      pagination: PAGINATION_EL
      ? {
          el: slider.querySelector('.jdslider__pagination'),
          type: 'bullets',
          bulletClass: 'jdslider__pagination-bullet',
          bulletActiveClass: 'jdslider__pagination-bullet--active',
          clickableClass: 'jdslider__pagination-bullet--clickable',
          clickable: PAGINATION_EL.dataset.clickable == 'true',
          renderBullet: function(index, className) {
            return `
              <button class="${className}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="jdslider__pagination-progress">
                  <circle cx="12" cy="12" r="${PAGINATION_RADIUS}"/>
                </svg>
              </button>
            `;
          }
        }
      : false,

      on: {
        init(swiper) {
          animateActiveSlide(swiper);
        },

        autoplayTimeLeft(swiper, time, progress) {
          if (!swiper.pagination?.bullets) return;

          const bullet = swiper.pagination.bullets[swiper.realIndex];
          const circle = bullet?.querySelector('.jdslider__pagination-progress');
          if (!circle) return;
          
          circle.style.strokeDashoffset = PAGINATION_CIRCUMFERENCE * (1 - progress);
        },

        slideChangeTransitionStart(swiper) {
          resetSlideItems(swiper);
        },

        slideChangeTransitionEnd(swiper) {
          animateActiveSlide(swiper)
        },
      }
    });

    // Store instance directly on DOM element
    slider.jdSwiper = swiper;
  }

  /**
   * Destroy slider inside ONE section
   */
  function destroySlider(section) {
    const slider = section.querySelector('.jdslider[data-tier="standard"]');
    if (!slider || !slider.jdSwiper) return;

    slider.jdSwiper.destroy(true, true);
    slider.jdSwiper = null;
  }

  /**
   * Init on page load
   */
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.shopify-section').forEach(function (section) {
      initSlider(section);
    });
  });

  /**
   * Shopify Theme Editor Events
   */
  document.addEventListener('shopify:section:load', function (event) {
    initSlider(event.target);
  });

  document.addEventListener('shopify:section:unload', function (event) {
    destroySlider(event.target);
  });

})();
{% endjavascript %}